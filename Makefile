# Kishax Infrastructure Makefile
# Terraform + EC2ç’°å¢ƒç”¨

# .envãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯èª­ã¿è¾¼ã‚€
ifneq (,$(wildcard ./.env))
    include .env
    export
endif

# AWS Profileè¨­å®š
AWS_PROFILE ?= AdministratorAccess-126112056177
AWS_REGION ?= ap-northeast-1
ENVIRONMENT ?= production
export AWS_PROFILE
export AWS_REGION
export ENVIRONMENT

# SSH Keyè¨­å®š
SSH_KEY = ./minecraft.pem

.PHONY: help
help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo "Kishax Infrastructure Makefile (Terraform + EC2)"
	@echo ""
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

## =============================================================================
## ç’°å¢ƒå¤‰æ•°ç®¡ç†
## =============================================================================

.PHONY: env-check
env-check: ## .envãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
	@if [ ! -f .env ]; then \
		echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo "ğŸ’¡ ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¦ãã ã•ã„:"; \
		echo "   cp .env.example .env"; \
		echo "   vi .env  # POSTGRES_PASSWORD ã¨ MYSQL_PASSWORD ã‚’è¨­å®š"; \
		exit 1; \
	fi
	@echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"

.PHONY: env-load
env-load: env-check ## Terraform outputã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
	@echo "ğŸ“¥ ç’°å¢ƒå¤‰æ•°ã‚’Terraform outputã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™..."
	@if [ ! -f .env ]; then \
		echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi
	@bash -c ' \
		set -e; \
		source .env; \
		echo "# Auto-generated by make env-load at $$(date)" > .env.auto; \
		echo "" >> .env.auto; \
		echo "# RDS Endpoints" >> .env.auto; \
		echo "export RDS_POSTGRES_ENDPOINT=\"$$(cd terraform && terraform output -raw postgres_endpoint 2>/dev/null)\"" >> .env.auto; \
		echo "export RDS_MYSQL_ENDPOINT=\"$$(cd terraform && terraform output -raw mysql_endpoint 2>/dev/null)\"" >> .env.auto; \
		echo "export RDS_POSTGRES_HOST=\"$$(cd terraform && terraform output -raw postgres_endpoint 2>/dev/null | cut -d: -f1)\"" >> .env.auto; \
		echo "export RDS_POSTGRES_PORT=\"$$(cd terraform && terraform output -raw postgres_endpoint 2>/dev/null | cut -d: -f2)\"" >> .env.auto; \
		echo "export RDS_MYSQL_HOST=\"$$(cd terraform && terraform output -raw mysql_endpoint 2>/dev/null | cut -d: -f1)\"" >> .env.auto; \
		echo "export RDS_MYSQL_PORT=\"$$(cd terraform && terraform output -raw mysql_endpoint 2>/dev/null | cut -d: -f2)\"" >> .env.auto; \
		echo "" >> .env.auto; \
		echo "# SQS" >> .env.auto; \
		echo "export TO_WEB_QUEUE_URL=\"$$(cd terraform && terraform output -raw to_web_queue_url 2>/dev/null)\"" >> .env.auto; \
		echo "export TO_MC_QUEUE_URL=\"$$(cd terraform && terraform output -raw to_mc_queue_url 2>/dev/null)\"" >> .env.auto; \
		echo "export TO_DISCORD_QUEUE_URL=\"$$(cd terraform && terraform output -raw discord_queue_url 2>/dev/null)\"" >> .env.auto; \
		echo "export MC_WEB_SQS_ACCESS_KEY_ID=\"$$(cd terraform && terraform output -raw sqs_access_key_id 2>/dev/null)\"" >> .env.auto; \
		echo "export MC_WEB_SQS_SECRET_ACCESS_KEY=\"$$(cd terraform && terraform output -raw sqs_secret_access_key 2>/dev/null)\"" >> .env.auto; \
		echo "" >> .env.auto; \
		echo "# S3" >> .env.auto; \
		echo "export S3_BUCKET=\"$$(cd terraform && terraform output -raw s3_docker_images_bucket_name 2>/dev/null)\"" >> .env.auto; \
		echo "export S3_IMAGE_MAPS_BUCKET=\"$$(cd terraform && terraform output -raw s3_image_maps_bucket_name 2>/dev/null)\"" >> .env.auto; \
		echo "export S3_WORLD_BACKUPS_BUCKET=\"$$(cd terraform && terraform output -raw s3_world_backups_bucket_name 2>/dev/null)\"" >> .env.auto; \
		echo "" >> .env.auto; \
		echo "# EC2 Instance IDs" >> .env.auto; \
		echo "export INSTANCE_ID_A=\"$$(cd terraform && terraform output -raw mc_server_instance_id 2>/dev/null)\"" >> .env.auto; \
		echo "export INSTANCE_ID_B=\"$$(cd terraform && terraform output -raw api_server_instance_id 2>/dev/null)\"" >> .env.auto; \
		echo "export INSTANCE_ID_C=\"$$(cd terraform && terraform output -raw web_server_instance_id 2>/dev/null)\"" >> .env.auto; \
		echo "export INSTANCE_ID_D=\"$$(cd terraform && terraform output -raw jump_server_instance_id 2>/dev/null)\"" >> .env.auto; \
		echo "" >> .env.auto; \
		echo "# EC2 Private IPs" >> .env.auto; \
		INST_A=$$(cd terraform && terraform output -raw mc_server_instance_id 2>/dev/null); \
		INST_B=$$(cd terraform && terraform output -raw api_server_instance_id 2>/dev/null); \
		INST_C=$$(cd terraform && terraform output -raw web_server_instance_id 2>/dev/null); \
		echo "export INSTANCE_ID_A_PRIVATE_IP=\"$$(aws ec2 describe-instances --instance-ids $$INST_A --query Reservations[0].Instances[0].PrivateIpAddress --output text 2>/dev/null || echo "")\"" >> .env.auto; \
		echo "export INSTANCE_ID_B_PRIVATE_IP=\"$$(aws ec2 describe-instances --instance-ids $$INST_B --query Reservations[0].Instances[0].PrivateIpAddress --output text 2>/dev/null || echo "")\"" >> .env.auto; \
		echo "export INSTANCE_ID_C_PRIVATE_IP=\"$$(aws ec2 describe-instances --instance-ids $$INST_C --query Reservations[0].Instances[0].PrivateIpAddress --output text 2>/dev/null || echo "")\"" >> .env.auto; \
		echo "" >> .env.auto; \
		echo "# Note: POSTGRES_PASSWORD and MYSQL_PASSWORD are defined in .env" >> .env.auto; \
		echo "# They are not re-exported here to avoid shell variable expansion issues" >> .env.auto; \
		echo "âœ… ç’°å¢ƒå¤‰æ•°ã‚’ .env.auto ã«ä¿å­˜ã—ã¾ã—ãŸ"; \
		echo "ğŸ’¡ ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§èª­ã¿è¾¼ã‚“ã§ãã ã•ã„:"; \
		echo "   source .env && source .env.auto"; \
	'

.PHONY: env-show
env-show: ## ç¾åœ¨ã®ç’°å¢ƒå¤‰æ•°ã‚’è¡¨ç¤º
	@echo "ğŸ“Š ç¾åœ¨ã®ç’°å¢ƒå¤‰æ•°:"
	@echo ""
	@echo "=== AWS ==="
	@echo "AWS_PROFILE: $$AWS_PROFILE"
	@echo "AWS_REGION: $$AWS_REGION"
	@echo ""
	@echo "=== RDS ==="
	@echo "RDS_POSTGRES_ENDPOINT: $$RDS_POSTGRES_ENDPOINT"
	@echo "RDS_MYSQL_ENDPOINT: $$RDS_MYSQL_ENDPOINT"
	@echo ""
	@echo "=== SQS ==="
	@echo "TO_WEB_QUEUE_URL: $$TO_WEB_QUEUE_URL"
	@echo "TO_MC_QUEUE_URL: $$TO_MC_QUEUE_URL"
	@echo "TO_DISCORD_QUEUE_URL: $$TO_DISCORD_QUEUE_URL"
	@echo ""
	@echo "=== S3 ==="
	@echo "S3_BUCKET: $$S3_BUCKET"
	@echo "S3_IMAGE_MAPS_BUCKET: $$S3_IMAGE_MAPS_BUCKET"
	@echo "S3_WORLD_BACKUPS_BUCKET: $$S3_WORLD_BACKUPS_BUCKET"
	@echo ""
	@echo "=== EC2 ==="
	@echo "INSTANCE_ID_A (MC): $$INSTANCE_ID_A"
	@echo "INSTANCE_ID_B (API): $$INSTANCE_ID_B"
	@echo "INSTANCE_ID_C (Web): $$INSTANCE_ID_C"
	@echo "INSTANCE_ID_D (Jump): $$INSTANCE_ID_D"
	@echo ""
	@echo "=== Private IPs ==="
	@echo "INSTANCE_ID_A_PRIVATE_IP: $$INSTANCE_ID_A_PRIVATE_IP"
	@echo "INSTANCE_ID_B_PRIVATE_IP: $$INSTANCE_ID_B_PRIVATE_IP"
	@echo "INSTANCE_ID_C_PRIVATE_IP: $$INSTANCE_ID_C_PRIVATE_IP"

## =============================================================================
## AWSèªè¨¼
## =============================================================================

.PHONY: login
login: ## AWS SSOãƒ­ã‚°ã‚¤ãƒ³
	@echo "ğŸ” AWS SSOãƒ­ã‚°ã‚¤ãƒ³ä¸­..."
	aws sso login --profile $(AWS_PROFILE)

.PHONY: whoami
whoami: ## ç¾åœ¨ã®AWSèªè¨¼æƒ…å ±ã‚’ç¢ºèª
	@echo "ğŸ‘¤ ç¾åœ¨ã®AWSèªè¨¼æƒ…å ±:"
	aws sts get-caller-identity --profile $(AWS_PROFILE)

## =============================================================================
## Gité–¢é€£
## =============================================================================

.PHONY: sync
sync: ## Gitã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æœ€æ–°ã«åŒæœŸ
	@echo "ğŸ”„ Gitã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸä¸­..."
	git submodule update --remote --merge

.PHONY: submodule-init
submodule-init: ## Gitã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–
	@echo "ğŸ”§ Gitã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–ä¸­..."
	git submodule update --init --recursive

## =============================================================================
## Terraform
## =============================================================================

.PHONY: tf-init
tf-init: ## Terraformã‚’åˆæœŸåŒ–
	@echo "ğŸ”§ TerraformåˆæœŸåŒ–ä¸­..."
	cd terraform && terraform init

.PHONY: tf-plan
tf-plan: ## Terraformãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆ
	@echo "ğŸ“ Terraformãƒ—ãƒ©ãƒ³ç”Ÿæˆä¸­..."
	cd terraform && terraform plan -out=tfplan

.PHONY: tf-apply
tf-apply: ## Terraformãƒ—ãƒ©ãƒ³ã‚’é©ç”¨
	@echo "ğŸš€ Terraformãƒ—ãƒ©ãƒ³é©ç”¨ä¸­..."
	cd terraform && terraform apply tfplan

.PHONY: tf-apply-auto
tf-apply-auto: ## Terraformãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•æ‰¿èªã§é©ç”¨
	@echo "ğŸš€ Terraformãƒ—ãƒ©ãƒ³é©ç”¨ä¸­ï¼ˆè‡ªå‹•æ‰¿èªï¼‰..."
	cd terraform && terraform apply -auto-approve

.PHONY: tf-destroy
tf-destroy: ## Terraformãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤
	@echo "âš ï¸  Terraformãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ä¸­..."
	@read -p "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ [y/N]: " confirm && [ "$$confirm" = "y" ] || exit 1
	cd terraform && terraform destroy

.PHONY: tf-output
tf-output: ## Terraformå‡ºåŠ›ã‚’è¡¨ç¤º
	@echo "ğŸ“Š Terraformå‡ºåŠ›:"
	cd terraform && terraform output

.PHONY: tf-fmt
tf-fmt: ## Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	@echo "âœ¨ Terraformãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
	cd terraform && terraform fmt -recursive

.PHONY: tf-validate
tf-validate: ## Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
	@echo "âœ… Terraformãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ä¸­..."
	cd terraform && terraform validate

## =============================================================================
## EC2ç®¡ç†
## =============================================================================

.PHONY: ec2-list
ec2-list: ## EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸€è¦§ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸€è¦§:"
	aws ec2 describe-instances \
		--profile $(AWS_PROFILE) \
		--query 'Reservations[*].Instances[*].[Tags[?Key==`Name`].Value|[0],InstanceId,InstanceType,State.Name,PublicIpAddress,PrivateIpAddress]' \
		--output table

.PHONY: ec2-connect-api
ec2-connect-api: ## i-b (API Server)ã«SSMæ¥ç¶š
	@echo "ğŸ”— i-b (API Server)ã«æ¥ç¶šä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw api_server_id 2>/dev/null); \
	if [ -z "$$INSTANCE_ID" ]; then \
		echo "âŒ API Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"; \
		exit 1; \
	fi; \
	aws ssm start-session --target $$INSTANCE_ID --profile $(AWS_PROFILE)

.PHONY: ec2-connect-web
ec2-connect-web: ## i-c (Web Server)ã«SSMæ¥ç¶š
	@echo "ğŸ”— i-c (Web Server)ã«æ¥ç¶šä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw web_server_id 2>/dev/null); \
	if [ -z "$$INSTANCE_ID" ]; then \
		echo "âŒ Web Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"; \
		exit 1; \
	fi; \
	aws ssm start-session --target $$INSTANCE_ID --profile $(AWS_PROFILE)

.PHONY: ec2-connect-mc
ec2-connect-mc: ## i-a (MC Server)ã«SSMæ¥ç¶š
	@echo "ğŸ”— i-a (MC Server)ã«æ¥ç¶šä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw mc_server_id 2>/dev/null); \
	if [ -z "$$INSTANCE_ID" ]; then \
		echo "âŒ MC Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"; \
		exit 1; \
	fi; \
	aws ssm start-session --target $$INSTANCE_ID --profile $(AWS_PROFILE)

.PHONY: ec2-connect-jump
ec2-connect-jump: ## i-d (Jump Server)ã«SSMæ¥ç¶š
	@echo "ğŸ”— i-d (Jump Server)ã«æ¥ç¶šä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw jump_server_id 2>/dev/null); \
	if [ -z "$$INSTANCE_ID" ]; then \
		echo "âŒ Jump Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"; \
		exit 1; \
	fi; \
	aws ssm start-session --target $$INSTANCE_ID --profile $(AWS_PROFILE)

.PHONY: ec2-start-mc
ec2-start-mc: ## i-a (MC Server)ã‚’èµ·å‹•
	@echo "â–¶ï¸  i-a (MC Server)èµ·å‹•ä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw mc_server_id 2>/dev/null); \
	aws ec2 start-instances --instance-ids $$INSTANCE_ID --profile $(AWS_PROFILE)

.PHONY: ec2-stop-mc
ec2-stop-mc: ## i-a (MC Server)ã‚’åœæ­¢
	@echo "â¹ï¸  i-a (MC Server)åœæ­¢ä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw mc_server_id 2>/dev/null); \
	aws ec2 stop-instances --instance-ids $$INSTANCE_ID --profile $(AWS_PROFILE)

.PHONY: ec2-start-jump
ec2-start-jump: ## i-d (Jump Server)ã‚’èµ·å‹•
	@echo "â–¶ï¸  i-d (Jump Server)èµ·å‹•ä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw jump_server_id 2>/dev/null); \
	aws ec2 start-instances --instance-ids $$INSTANCE_ID --profile $(AWS_PROFILE)

.PHONY: ec2-stop-jump
ec2-stop-jump: ## i-d (Jump Server)ã‚’åœæ­¢
	@echo "â¹ï¸  i-d (Jump Server)åœæ­¢ä¸­..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw jump_server_id 2>/dev/null); \
	aws ec2 stop-instances --instance-ids $$INSTANCE_ID --profile $(AWS_PROFILE)

## =============================================================================
## SSMæ¥ç¶šï¼ˆãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° - ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’å æœ‰ï¼‰
## =============================================================================

.PHONY: ssm-mc ssm-api ssm-web ssm-jump ssm-mysql ssm-postgres

ssm-mc: ## i-a (MC Server) ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (localhost:2222)
	@echo "ğŸ”— MC Server (i-a) ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™..."
	@INSTANCE_ID_D=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-jump-server" "Name=instance-state-name,Values=running" \
		--query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null); \
	PRIVATE_IP_A=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-mc-server" \
		--query 'Reservations[0].Instances[0].PrivateIpAddress' --output text 2>/dev/null); \
	if [ -z "$$INSTANCE_ID_D" ] || [ "$$INSTANCE_ID_D" = "None" ]; then \
		echo "âŒ Jump ServerãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	if [ -z "$$PRIVATE_IP_A" ] || [ "$$PRIVATE_IP_A" = "None" ]; then \
		echo "âŒ MC ServerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	echo "Jump Server: $$INSTANCE_ID_D"; \
	echo "Target: $$PRIVATE_IP_A (MC Server)"; \
	echo "Local Port: 2222"; \
	echo ""; \
	echo "âœ… ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹ (ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯å æœ‰ã•ã‚Œã¾ã™)"; \
	echo "ğŸ“ åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssh-mc' ã‚’å®Ÿè¡Œã—ã¦SSHæ¥ç¶šã—ã¦ãã ã•ã„"; \
	echo ""; \
	aws ssm start-session \
		--target $$INSTANCE_ID_D \
		--document-name AWS-StartPortForwardingSessionToRemoteHost \
		--parameters "{\"host\":[\"$$PRIVATE_IP_A\"],\"portNumber\":[\"22\"],\"localPortNumber\":[\"2222\"]}" \
		--profile $(AWS_PROFILE)

ssm-api: ## i-b (API Server) ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (localhost:2223)
	@echo "ğŸ”— API Server (i-b) ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™..."
	@INSTANCE_ID_D=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-jump-server" "Name=instance-state-name,Values=running" \
		--query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null); \
	PRIVATE_IP_B=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-api-server" \
		--query 'Reservations[0].Instances[0].PrivateIpAddress' --output text 2>/dev/null); \
	if [ -z "$$INSTANCE_ID_D" ] || [ "$$INSTANCE_ID_D" = "None" ]; then \
		echo "âŒ Jump ServerãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	if [ -z "$$PRIVATE_IP_B" ] || [ "$$PRIVATE_IP_B" = "None" ]; then \
		echo "âŒ API ServerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	echo "Jump Server: $$INSTANCE_ID_D"; \
	echo "Target: $$PRIVATE_IP_B (API Server)"; \
	echo "Local Port: 2223"; \
	echo ""; \
	echo "âœ… ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹ (ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯å æœ‰ã•ã‚Œã¾ã™)"; \
	echo "ğŸ“ åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssh-api' ã‚’å®Ÿè¡Œã—ã¦SSHæ¥ç¶šã—ã¦ãã ã•ã„"; \
	echo ""; \
	aws ssm start-session \
		--target $$INSTANCE_ID_D \
		--document-name AWS-StartPortForwardingSessionToRemoteHost \
		--parameters "{\"host\":[\"$$PRIVATE_IP_B\"],\"portNumber\":[\"22\"],\"localPortNumber\":[\"2223\"]}" \
		--profile $(AWS_PROFILE)

ssm-web: ## i-c (Web Server) ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (localhost:2224)
	@echo "ğŸ”— Web Server (i-c) ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™..."
	@INSTANCE_ID_D=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-jump-server" "Name=instance-state-name,Values=running" \
		--query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null); \
	PRIVATE_IP_C=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-web-server" \
		--query 'Reservations[0].Instances[0].PrivateIpAddress' --output text 2>/dev/null); \
	if [ -z "$$INSTANCE_ID_D" ] || [ "$$INSTANCE_ID_D" = "None" ]; then \
		echo "âŒ Jump ServerãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	if [ -z "$$PRIVATE_IP_C" ] || [ "$$PRIVATE_IP_C" = "None" ]; then \
		echo "âŒ Web ServerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	echo "Jump Server: $$INSTANCE_ID_D"; \
	echo "Target: $$PRIVATE_IP_C (Web Server)"; \
	echo "Local Port: 2224"; \
	echo ""; \
	echo "âœ… ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹ (ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯å æœ‰ã•ã‚Œã¾ã™)"; \
	echo "ğŸ“ åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssh-web' ã‚’å®Ÿè¡Œã—ã¦SSHæ¥ç¶šã—ã¦ãã ã•ã„"; \
	echo ""; \
	aws ssm start-session \
		--target $$INSTANCE_ID_D \
		--document-name AWS-StartPortForwardingSessionToRemoteHost \
		--parameters "{\"host\":[\"$$PRIVATE_IP_C\"],\"portNumber\":[\"22\"],\"localPortNumber\":[\"2224\"]}" \
		--profile $(AWS_PROFILE)

ssm-jump: ## i-d (Jump Server) ã¸SSMç›´æ¥æ¥ç¶š
	@echo "ğŸ”— Jump Server (i-d) ã¸SSMã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™..."
	@INSTANCE_ID=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-jump-server" "Name=instance-state-name,Values=running" \
		--query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null); \
	if [ -z "$$INSTANCE_ID" ] || [ "$$INSTANCE_ID" = "None" ]; then \
		echo "âŒ Jump ServerãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	echo "Instance ID: $$INSTANCE_ID"; \
	echo ""; \
	aws ssm start-session --target $$INSTANCE_ID --profile $(AWS_PROFILE)

ssm-mysql: ## RDS MySQL ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (localhost:3307)
	@echo "ğŸ”— RDS MySQL ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™..."
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env.auto; \
	if [ -z "$$RDS_MYSQL_HOST" ]; then \
		echo "âŒ RDS_MYSQL_HOSTãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	INSTANCE_ID_D=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-jump-server" "Name=instance-state-name,Values=running" \
		--query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null); \
	if [ -z "$$INSTANCE_ID_D" ] || [ "$$INSTANCE_ID_D" = "None" ]; then \
		echo "âŒ Jump ServerãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	echo "Jump Server: $$INSTANCE_ID_D"; \
	echo "Target: $$RDS_MYSQL_HOST:$$RDS_MYSQL_PORT"; \
	echo "Local Port: 3307"; \
	echo "Database: kishax_mc"; \
	echo ""; \
	echo "âœ… ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹ (ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯å æœ‰ã•ã‚Œã¾ã™)"; \
	echo "ğŸ“ åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssh-mysql' ã‚’å®Ÿè¡Œã—ã¦MySQLæ¥ç¶šã—ã¦ãã ã•ã„"; \
	echo ""; \
	aws ssm start-session \
		--target $$INSTANCE_ID_D \
		--document-name AWS-StartPortForwardingSessionToRemoteHost \
		--parameters "{\"host\":[\"$$RDS_MYSQL_HOST\"],\"portNumber\":[\"$$RDS_MYSQL_PORT\"],\"localPortNumber\":[\"3307\"]}" \
		--profile $(AWS_PROFILE)

ssm-postgres: ## RDS PostgreSQL ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (localhost:5433)
	@echo "ğŸ”— RDS PostgreSQL ã¸ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™..."
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env.auto; \
	if [ -z "$$RDS_POSTGRES_HOST" ]; then \
		echo "âŒ RDS_POSTGRES_HOSTãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	INSTANCE_ID_D=$$(aws ec2 describe-instances --profile $(AWS_PROFILE) --region $(AWS_REGION) \
		--filters "Name=tag:Name,Values=kishax-$(ENVIRONMENT)-jump-server" "Name=instance-state-name,Values=running" \
		--query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null); \
	if [ -z "$$INSTANCE_ID_D" ] || [ "$$INSTANCE_ID_D" = "None" ]; then \
		echo "âŒ Jump ServerãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	echo "Jump Server: $$INSTANCE_ID_D"; \
	echo "Target: $$RDS_POSTGRES_HOST:$$RDS_POSTGRES_PORT"; \
	echo "Local Port: 5433"; \
	echo "Database: kishax_web"; \
	echo ""; \
	echo "âœ… ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹ (ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯å æœ‰ã•ã‚Œã¾ã™)"; \
	echo "ğŸ“ åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssh-postgres' ã‚’å®Ÿè¡Œã—ã¦PostgreSQLæ¥ç¶šã—ã¦ãã ã•ã„"; \
	echo ""; \
	aws ssm start-session \
		--target $$INSTANCE_ID_D \
		--document-name AWS-StartPortForwardingSessionToRemoteHost \
		--parameters "{\"host\":[\"$$RDS_POSTGRES_HOST\"],\"portNumber\":[\"$$RDS_POSTGRES_PORT\"],\"localPortNumber\":[\"5433\"]}" \
		--profile $(AWS_PROFILE)

## =============================================================================
## SSHæ¥ç¶šï¼ˆç´”ç²‹ãªSSH - äº‹å‰ã« ssm-* ã§ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå¿…è¦ï¼‰
## =============================================================================

.PHONY: ssh-mc ssh-api ssh-web ssh-mysql ssh-postgres

ssh-mc: ## i-a (MC Server) ã¸SSHæ¥ç¶š (è¦: åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ make ssm-mc)
	@echo "ğŸ”— MC Server (i-a) ã¸SSHæ¥ç¶šã—ã¾ã™..."
	@if [ ! -f "$(SSH_KEY)" ]; then \
		echo "âŒ SSHéµãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $(SSH_KEY)"; \
		exit 1; \
	fi; \
	echo "SSH Key: $(SSH_KEY)"; \
	echo "Local Port: 2222"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-mc' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	if grep -q "\[localhost\]:2222" ~/.ssh/known_hosts 2>/dev/null; then \
		echo "âš ï¸  known_hostsã«[localhost]:2222ã®ã‚¨ãƒ³ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"; \
		read -p "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
		if [ "$$answer" = "y" ] || [ "$$answer" = "Y" ]; then \
			ssh-keygen -R "[localhost]:2222" 2>/dev/null || true; \
			echo "âœ… known_hostsã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ"; \
		fi; \
	fi; \
	ssh -i $(SSH_KEY) -p 2222 ec2-user@localhost

ssh-api: ## i-b (API Server) ã¸SSHæ¥ç¶š (è¦: åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ make ssm-api)
	@echo "ğŸ”— API Server (i-b) ã¸SSHæ¥ç¶šã—ã¾ã™..."
	@if [ ! -f "$(SSH_KEY)" ]; then \
		echo "âŒ SSHéµãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $(SSH_KEY)"; \
		exit 1; \
	fi; \
	echo "SSH Key: $(SSH_KEY)"; \
	echo "Local Port: 2223"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-api' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	if grep -q "\[localhost\]:2223" ~/.ssh/known_hosts 2>/dev/null; then \
		echo "âš ï¸  known_hostsã«[localhost]:2223ã®ã‚¨ãƒ³ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"; \
		read -p "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
		if [ "$$answer" = "y" ] || [ "$$answer" = "Y" ]; then \
			ssh-keygen -R "[localhost]:2223" 2>/dev/null || true; \
			echo "âœ… known_hostsã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ"; \
		fi; \
	fi; \
	ssh -i $(SSH_KEY) -p 2223 ec2-user@localhost

ssh-web: ## i-c (Web Server) ã¸SSHæ¥ç¶š (è¦: åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ make ssm-web)
	@echo "ğŸ”— Web Server (i-c) ã¸SSHæ¥ç¶šã—ã¾ã™..."
	@if [ ! -f "$(SSH_KEY)" ]; then \
		echo "âŒ SSHéµãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $(SSH_KEY)"; \
		exit 1; \
	fi; \
	echo "SSH Key: $(SSH_KEY)"; \
	echo "Local Port: 2224"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-web' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	if grep -q "\[localhost\]:2224" ~/.ssh/known_hosts 2>/dev/null; then \
		echo "âš ï¸  known_hostsã«[localhost]:2224ã®ã‚¨ãƒ³ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"; \
		read -p "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
		if [ "$$answer" = "y" ] || [ "$$answer" = "Y" ]; then \
			ssh-keygen -R "[localhost]:2224" 2>/dev/null || true; \
			echo "âœ… known_hostsã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ"; \
		fi; \
	fi; \
	ssh -i $(SSH_KEY) -p 2224 ec2-user@localhost

ssh-mysql: ## RDS MySQL ã¸MySQLæ¥ç¶š (è¦: åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ make ssm-mysql)
	@echo "ğŸ”— RDS MySQL ã¸MySQLæ¥ç¶šã—ã¾ã™..."
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	if [ -z "$$MYSQL_PASSWORD" ]; then \
		echo "âŒ MYSQL_PASSWORDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	MYSQL_USER=$${MYSQL_USER:-root}; \
	echo "Database: kishax_mc"; \
	echo "User: $$MYSQL_USER"; \
	echo "Host: localhost:3307"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-mysql' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	mysql -h 127.0.0.1 -P 3307 -u "$$MYSQL_USER" -p"$$MYSQL_PASSWORD" kishax_mc

ssh-postgres: ## RDS PostgreSQL ã¸psqlæ¥ç¶š (è¦: åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ make ssm-postgres)
	@echo "ğŸ”— RDS PostgreSQL ã¸psqlæ¥ç¶šã—ã¾ã™..."
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	if [ -z "$$POSTGRES_PASSWORD" ]; then \
		echo "âŒ POSTGRES_PASSWORDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	POSTGRES_USER=$${POSTGRES_USER:-postgres}; \
	echo "Database: kishax_web"; \
	echo "User: $$POSTGRES_USER"; \
	echo "Host: localhost:5433"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-postgres' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	PGPASSWORD="$$POSTGRES_PASSWORD" psql -h 127.0.0.1 -p 5433 -U "$$POSTGRES_USER" -d kishax_web

## =============================================================================
## MySQL ã‚·ãƒ¼ãƒ‰ç®¡ç†
## =============================================================================

.PHONY: mysql-seed-list mysql-seed-import mysql-seed-tables mysql-seed-s3 mysql-seed-all mysql-seed-reset mysql-seed-fix-db-names

mysql-seed-tables: ## MySQLãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ (è¦: make ssm-mysql)
	@echo "ğŸ”§ MySQLãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	if [ ! -f .db/mc/TABLES.sql ]; then \
		echo "âŒ .db/mc/TABLES.sql ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	if [ -z "$$MYSQL_PASSWORD" ]; then \
		echo "âŒ MYSQL_PASSWORDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ğŸ’¡ 'source .env && source .env.auto' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	MYSQL_USER=$${MYSQL_USER:-root}; \
	echo "Database: kishax_mc"; \
	echo "User: $$MYSQL_USER"; \
	echo "Host: localhost:3307"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-mysql' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	read -p "ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" != "y" ] && [ "$$answer" != "Y" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸ”§ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆä¸­..."; \
	mysql -h 127.0.0.1 -P 3307 -u "$$MYSQL_USER" -p"$$MYSQL_PASSWORD" kishax_mc < .db/mc/TABLES.sql 2>&1 | grep -v "Using a password on the command line" || true; \
	if [ $$? -eq 0 ]; then \
		echo "âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"; \
		exit 1; \
	fi

mysql-seed-list: ## .db/mc ã®ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ MySQLã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
	@echo ""
	@if [ -d .db/mc ]; then \
		ls -lh .db/mc/*.sql 2>/dev/null | awk '{print "  " $$9 " (" $$5 ")"}' || echo "  ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	else \
		echo "  âŒ .db/mc ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
	fi

mysql-seed-import: ## æŒ‡å®šã—ãŸã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’RDS MySQLã«æŒ¿å…¥ (è¦: make ssm-mysql)
	@echo "ğŸ“¥ MySQLã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	if [ -z "$(FILE)" ]; then \
		echo "âŒ FILEãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo ""; \
		echo "ä¾‹: make mysql-seed-import FILE=.db/mc/s3_image_storage_settings_fixed.sql"; \
		echo ""; \
		$(MAKE) mysql-seed-list; \
		exit 1; \
	fi; \
	if [ ! -f "$(FILE)" ]; then \
		echo "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $(FILE)"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	MYSQL_USER=$${MYSQL_USER:-root}; \
	echo "ãƒ•ã‚¡ã‚¤ãƒ«: $(FILE)"; \
	echo "Database: kishax_mc"; \
	echo "User: $$MYSQL_USER"; \
	echo "Host: localhost:3307"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-mysql' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	read -p "ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" = "y" ] || [ "$$answer" = "Y" ]; then \
		ERROR_OUTPUT=$$(mysql -h 127.0.0.1 -P 3307 -u "$$MYSQL_USER" -p"$$MYSQL_PASSWORD" kishax_mc < "$(FILE)" 2>&1 | grep -v "Using a password on the command line"); \
		if [ -z "$$ERROR_OUTPUT" ]; then \
			echo ""; \
			echo "âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†"; \
		else \
			echo ""; \
			echo "âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"; \
			echo "ğŸ“ ã‚¨ãƒ©ãƒ¼: $$ERROR_OUTPUT"; \
			exit 1; \
		fi; \
	else \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
	fi

mysql-seed-s3: ## S3ç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (è¦: make ssm-mysql)
	@$(MAKE) mysql-seed-import FILE=.db/mc/s3_image_storage_settings_fixed.sql

mysql-seed-fix-db-names: ## .db/mc ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã‚’ä¿®æ­£ (mc. -> kishax_mc.)
	@echo "ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã‚’ä¿®æ­£ã—ã¾ã™ (mc. -> kishax_mc.)"
	@echo ""
	@if [ ! -d .db/mc ]; then \
		echo "âŒ .db/mc ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	echo "ğŸ“‹ ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:"; \
	for file in .db/mc/*.sql; do \
		if [ -f "$$file" ] && ! echo "$$file" | grep -q "_fixed.sql"; then \
			if grep -q "INSERT INTO mc\." "$$file" 2>/dev/null; then \
				echo "  - $$(basename $$file)"; \
			fi; \
		fi; \
	done; \
	echo ""; \
	read -p "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" != "y" ] && [ "$$answer" != "Y" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸ”§ ä¿®æ­£ä¸­..."; \
	SUCCESS_COUNT=0; \
	for file in .db/mc/*.sql; do \
		if [ -f "$$file" ] && ! echo "$$file" | grep -q "_fixed.sql"; then \
			FILE_NAME=$$(basename "$$file"); \
			if grep -q "INSERT INTO mc\." "$$file" 2>/dev/null; then \
				sed 's/INSERT INTO mc\./INSERT INTO kishax_mc./g' "$$file" > "$${file%.sql}_fixed.sql"; \
				if [ -f "$${file%.sql}_fixed.sql" ]; then \
					echo "  âœ… $$FILE_NAME -> $${FILE_NAME%.sql}_fixed.sql"; \
					SUCCESS_COUNT=$$((SUCCESS_COUNT + 1)); \
				fi; \
			fi; \
		fi; \
	done; \
	echo ""; \
	echo "âœ… $$SUCCESS_COUNT ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¾ã—ãŸ"; \
	echo "ğŸ’¡ ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ *_fixed.sql ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™"

mysql-seed-reset: ## kishax_mc ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ (è¦: make ssm-mysql)
	@echo "ğŸ—‘ï¸  MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	MYSQL_USER=$${MYSQL_USER:-root}; \
	echo "Database: kishax_mc"; \
	echo "User: $$MYSQL_USER"; \
	echo "Host: localhost:3307"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-mysql' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo "âš ï¸  è­¦å‘Š: å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼"; \
	echo ""; \
	read -p "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (yes/N): " answer; \
	if [ "$$answer" != "yes" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸ—‘ï¸  ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ä¸­..."; \
	mysql -h 127.0.0.1 -P 3307 -u "$$MYSQL_USER" -p"$$MYSQL_PASSWORD" kishax_mc -e " \
		SET FOREIGN_KEY_CHECKS = 0; \
		SET @tables = NULL; \
		SELECT GROUP_CONCAT(table_name) INTO @tables \
		  FROM information_schema.tables \
		  WHERE table_schema = 'kishax_mc'; \
		SET @tables = CONCAT('DROP TABLE IF EXISTS ', @tables); \
		PREPARE stmt FROM @tables; \
		EXECUTE stmt; \
		DEALLOCATE PREPARE stmt; \
		SET FOREIGN_KEY_CHECKS = 1; \
	" 2>/dev/null; \
	echo ""; \
	echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"; \
	echo "ğŸ’¡ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆã™ã‚‹ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¦ãã ã•ã„"

mysql-seed-all: ## .db/mc ã®å…¨ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (è¦: make ssm-mysql)
	@echo "ğŸ“¥ MySQL å…¨ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	if [ ! -d .db/mc ]; then \
		echo "âŒ .db/mc ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	FILE_COUNT=$$(ls -1 .db/mc/*_fixed.sql 2>/dev/null | wc -l | tr -d ' '); \
	if [ "$$FILE_COUNT" -eq 0 ]; then \
		echo "âŒ .db/mc ã«*_fixed.sqlãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo "ğŸ’¡ 'make mysql-seed-fix-db-names' ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	if [ -z "$$MYSQL_PASSWORD" ]; then \
		echo "âŒ MYSQL_PASSWORDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ğŸ’¡ 'source .env && source .env.auto' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	MYSQL_USER=$${MYSQL_USER:-root}; \
	echo "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $$FILE_COUNT"; \
	echo "Database: kishax_mc"; \
	echo "Host: localhost:3307"; \
	echo "User: $$MYSQL_USER"; \
	echo "Password length: $${#MYSQL_PASSWORD}"; \
	echo ""; \
	echo "ğŸ” MySQLæ¥ç¶šç¢ºèªä¸­..."; \
	CONNECTION_TEST=$$(mysql -h 127.0.0.1 -P 3307 -u "$$MYSQL_USER" -p"$$MYSQL_PASSWORD" -e "SELECT 1" kishax_mc 2>&1 | grep -v "Using a password on the command line"); \
	if [ $$? -ne 0 ] || echo "$$CONNECTION_TEST" | grep -q "ERROR"; then \
		echo "âŒ MySQLã«æ¥ç¶šã§ãã¾ã›ã‚“"; \
		echo ""; \
		echo "ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°:"; \
		echo "$$CONNECTION_TEST" | head -n 3; \
		echo ""; \
		echo "ğŸ’¡ è§£æ±ºæ–¹æ³•:"; \
		echo "   1. åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-mysql' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		echo "   2. ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã‚‹ã¾ã§å¾…ã¡ã¾ã™"; \
		echo "      ('Port 3307 opened' ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª)"; \
		echo "   3. ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'source .env && source .env.auto' ã‚’å®Ÿè¡Œ"; \
		echo "   4. å†åº¦ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		echo ""; \
		echo "ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"; \
		echo "   - ãƒãƒ¼ãƒˆç¢ºèª: lsof -i :3307"; \
		echo "   - æ‰‹å‹•æ¥ç¶š: mysql -h 127.0.0.1 -P 3307 -u $$MYSQL_USER -p kishax_mc"; \
		echo ""; \
		exit 1; \
	fi; \
	echo "âœ… MySQLæ¥ç¶šæˆåŠŸ"; \
	echo ""; \
	echo "ğŸ“‹ å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"; \
	ls -1h .db/mc/*_fixed.sql | while read file; do \
		SIZE=$$(ls -lh "$$file" | awk '{print $$5}'); \
		echo "  - $$(basename $$file) ($$SIZE)"; \
	done; \
	echo ""; \
	echo "âš ï¸  å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã€æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"; \
	echo ""; \
	read -p "å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" != "y" ] && [ "$$answer" != "Y" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸš€ ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹..."; \
	echo ""; \
	SUCCESS_COUNT=0; \
	FAIL_COUNT=0; \
	FAILED_FILES=""; \
	for sql_file in .db/mc/*_fixed.sql; do \
		if [ -f "$$sql_file" ]; then \
			FILE_NAME=$$(basename "$$sql_file"); \
			FILE_SIZE=$$(ls -lh "$$sql_file" | awk '{print $$5}'); \
			echo "ğŸ“„ [$$((SUCCESS_COUNT + FAIL_COUNT + 1))/$$FILE_COUNT] $$FILE_NAME ($$FILE_SIZE)..."; \
			ERROR_MSG=$$(mysql -h 127.0.0.1 -P 3307 -u "$$MYSQL_USER" -p"$$MYSQL_PASSWORD" kishax_mc < "$$sql_file" 2>&1 | grep -v "Using a password on the command line"); \
			EXIT_CODE=$$?; \
			if [ $$EXIT_CODE -eq 0 ] && [ -z "$$ERROR_MSG" ]; then \
				echo "   âœ… æˆåŠŸ"; \
				SUCCESS_COUNT=$$((SUCCESS_COUNT + 1)); \
			else \
				if [ -n "$$ERROR_MSG" ]; then \
					echo "   âŒ å¤±æ•—"; \
					echo "   ğŸ“ ã‚¨ãƒ©ãƒ¼: $$(echo "$$ERROR_MSG" | head -n 1)"; \
					FAIL_COUNT=$$((FAIL_COUNT + 1)); \
					FAILED_FILES="$$FAILED_FILES  - $$FILE_NAME\n"; \
				else \
					echo "   âœ… æˆåŠŸ"; \
					SUCCESS_COUNT=$$((SUCCESS_COUNT + 1)); \
				fi; \
			fi; \
			echo ""; \
		fi; \
	done; \
	echo ""; \
	echo "========================================"; \
	echo "ğŸ“Š ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ"; \
	echo "========================================"; \
	echo "âœ… æˆåŠŸ: $$SUCCESS_COUNT / $$FILE_COUNT"; \
	echo "âŒ å¤±æ•—: $$FAIL_COUNT / $$FILE_COUNT"; \
	echo "========================================"; \
	if [ $$FAIL_COUNT -gt 0 ]; then \
		echo ""; \
		echo "âš ï¸  å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«:"; \
		echo -e "$$FAILED_FILES"; \
		echo "ğŸ’¡ å€‹åˆ¥ã«ç¢ºèªã™ã‚‹ã«ã¯:"; \
		echo "   make mysql-seed-import FILE=.db/mc/[ãƒ•ã‚¡ã‚¤ãƒ«å]"; \
	fi

## =============================================================================
## PostgreSQL ã‚·ãƒ¼ãƒ‰ç®¡ç†
## =============================================================================

.PHONY: postgres-create-db postgres-seed-tables postgres-seed-list postgres-seed-import postgres-seed-users postgres-seed-all postgres-seed-reset

postgres-create-db: ## PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (kishax_web) ã‚’ä½œæˆ (è¦: make ssm-postgres)
	@echo "ğŸ”§ PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	if [ -z "$$POSTGRES_PASSWORD" ]; then \
		echo "âŒ POSTGRES_PASSWORDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	POSTGRES_USER=$${POSTGRES_USER:-postgres}; \
	echo "Database: kishax_web"; \
	echo "User: $$POSTGRES_USER"; \
	echo "Host: localhost:5433"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-postgres' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	read -p "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" != "y" ] && [ "$$answer" != "Y" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆä¸­..."; \
	PGPASSWORD="$$POSTGRES_PASSWORD" psql -h 127.0.0.1 -p 5433 -U "$$POSTGRES_USER" -d postgres -c "CREATE DATABASE kishax_web;" 2>&1 | grep -v "already exists" || true; \
	if [ $$? -eq 0 ]; then \
		echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆã¾ãŸã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼‰"; \
	else \
		echo "âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"; \
		exit 1; \
	fi

postgres-seed-tables: ## PostgreSQLãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ (Prisma migrate) (è¦: make ssm-postgres)
	@echo "ğŸ”§ PostgreSQLãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ (Prisma)"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	if [ ! -d apps/web/prisma ]; then \
		echo "âŒ apps/web/prisma ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	POSTGRES_USER=$${POSTGRES_USER:-postgres}; \
	echo "Database: kishax_web"; \
	echo "User: $$POSTGRES_USER"; \
	echo "Host: 127.0.0.1:5433"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-postgres' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	read -p "Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" != "y" ] && [ "$$answer" != "Y" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸ”§ Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­..."; \
	ENCODED_PASSWORD=$$(python3 -c "import urllib.parse; print(urllib.parse.quote_plus('$$POSTGRES_PASSWORD'))"); \
	cd apps/web && DATABASE_URL="postgresql://$$POSTGRES_USER:$$ENCODED_PASSWORD@127.0.0.1:5433/kishax_web" npx prisma db push --skip-generate; \
	if [ $$? -eq 0 ]; then \
		echo "âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"; \
	else \
		echo "âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"; \
		exit 1; \
	fi

postgres-seed-list: ## .db/web ã®ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ PostgreSQLã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
	@echo ""
	@if [ -d .db/web ]; then \
		ls -lh .db/web/*.sql 2>/dev/null | awk '{print "  " $$9 " (" $$5 ")"}' || echo "  ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	else \
		echo "  âŒ .db/web ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
	fi

postgres-seed-import: ## æŒ‡å®šã—ãŸã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’RDS PostgreSQLã«æŒ¿å…¥ (è¦: make ssm-postgres)
	@echo "ğŸ“¥ PostgreSQLã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	if [ -z "$(FILE)" ]; then \
		echo "âŒ FILEãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo ""; \
		echo "ä¾‹: make postgres-seed-import FILE=.db/web/users_migrated_seed.sql"; \
		echo ""; \
		$(MAKE) postgres-seed-list; \
		exit 1; \
	fi; \
	if [ ! -f "$(FILE)" ]; then \
		echo "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $(FILE)"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	POSTGRES_USER=$${POSTGRES_USER:-postgres}; \
	echo "ãƒ•ã‚¡ã‚¤ãƒ«: $(FILE)"; \
	echo "Database: kishax_web"; \
	echo "User: $$POSTGRES_USER"; \
	echo "Host: localhost:5433"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-postgres' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo ""; \
	read -p "ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" = "y" ] || [ "$$answer" = "Y" ]; then \
		PGPASSWORD="$$POSTGRES_PASSWORD" psql -h 127.0.0.1 -p 5433 -U "$$POSTGRES_USER" -d kishax_web -f "$(FILE)"; \
		echo ""; \
		echo "âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†"; \
	else \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
	fi

postgres-seed-users: ## ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (è¦: make ssm-postgres)
	@$(MAKE) postgres-seed-import FILE=.db/web/users_migrated_seed.sql

postgres-seed-reset: ## kishax_web ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ (è¦: make ssm-postgres)
	@echo "ğŸ—‘ï¸  PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	POSTGRES_USER=$${POSTGRES_USER:-postgres}; \
	echo "Database: kishax_web"; \
	echo "User: $$POSTGRES_USER"; \
	echo "Host: localhost:5433"; \
	echo ""; \
	echo "âš ï¸  äº‹å‰ã«åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-postgres' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	echo "âš ï¸  è­¦å‘Š: å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼"; \
	echo ""; \
	read -p "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (yes/N): " answer; \
	if [ "$$answer" != "yes" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸ—‘ï¸  ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ä¸­..."; \
	PGPASSWORD="$$POSTGRES_PASSWORD" psql -h 127.0.0.1 -p 5433 -U "$$POSTGRES_USER" -d kishax_web -c " \
		DO \$\$ DECLARE \
			r RECORD; \
		BEGIN \
			FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP \
				EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE'; \
			END LOOP; \
		END \$\$; \
	" 2>/dev/null; \
	echo ""; \
	echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"; \
	echo "ğŸ’¡ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†ä½œæˆã™ã‚‹ã«ã¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"

postgres-seed-all: ## .db/web ã®å…¨ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (è¦: make ssm-postgres)
	@echo "ğŸ“¥ PostgreSQL å…¨ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™"
	@echo ""
	@if [ ! -f .env.auto ]; then \
		echo "âŒ .env.autoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'make env-load'ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	if [ ! -d .db/web ]; then \
		echo "âŒ .db/web ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	FILE_COUNT=$$(ls -1 .db/web/*.sql 2>/dev/null | wc -l | tr -d ' '); \
	if [ "$$FILE_COUNT" -eq 0 ]; then \
		echo "âŒ .db/web ã«SQLãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi; \
	source .env && source .env.auto; \
	if [ -z "$$POSTGRES_PASSWORD" ]; then \
		echo "âŒ POSTGRES_PASSWORDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ğŸ’¡ 'source .env && source .env.auto' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		exit 1; \
	fi; \
	POSTGRES_USER=$${POSTGRES_USER:-postgres}; \
	echo "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $$FILE_COUNT"; \
	echo "Database: kishax_web"; \
	echo "Host: localhost:5433"; \
	echo "User: $$POSTGRES_USER"; \
	echo ""; \
	echo "ğŸ” PostgreSQLæ¥ç¶šç¢ºèªä¸­..."; \
	CONNECTION_TEST=$$(PGPASSWORD="$$POSTGRES_PASSWORD" psql -h 127.0.0.1 -p 5433 -U "$$POSTGRES_USER" -d kishax_web -c "SELECT 1" 2>&1); \
	if [ $$? -ne 0 ]; then \
		echo "âŒ PostgreSQLã«æ¥ç¶šã§ãã¾ã›ã‚“"; \
		echo ""; \
		echo "ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°:"; \
		echo "$$CONNECTION_TEST" | head -n 3; \
		echo ""; \
		echo "ğŸ’¡ è§£æ±ºæ–¹æ³•:"; \
		echo "   1. åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make ssm-postgres' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		echo "   2. ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã‚‹ã¾ã§å¾…ã¡ã¾ã™"; \
		echo "      ('Port 5433 opened' ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª)"; \
		echo "   3. ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'source .env && source .env.auto' ã‚’å®Ÿè¡Œ"; \
		echo "   4. å†åº¦ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
		echo ""; \
		echo "ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"; \
		echo "   - ãƒãƒ¼ãƒˆç¢ºèª: lsof -i :5433"; \
		echo "   - æ‰‹å‹•æ¥ç¶š: PGPASSWORD=*** psql -h 127.0.0.1 -p 5433 -U $$POSTGRES_USER -d kishax_web"; \
		echo ""; \
		exit 1; \
	fi; \
	echo "âœ… PostgreSQLæ¥ç¶šæˆåŠŸ"; \
	echo ""; \
	echo "ğŸ“‹ å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"; \
	ls -1h .db/web/*.sql | while read file; do \
		FILE_NAME=$$(basename "$$file"); \
		if ! echo "$$FILE_NAME" | grep -q "^counter_"; then \
			SIZE=$$(ls -lh "$$file" | awk '{print $$5}'); \
			echo "  - $$FILE_NAME ($$SIZE)"; \
		fi; \
	done; \
	echo ""; \
	echo "ğŸ’¡ counter_*.sql ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼ˆã‚¹ã‚­ãƒ¼ãƒäº’æ›æ€§ãªã—ï¼‰"; \
	echo ""; \
	read -p "å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ (y/N): " answer; \
	if [ "$$answer" != "y" ] && [ "$$answer" != "Y" ]; then \
		echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		exit 0; \
	fi; \
	echo ""; \
	echo "ğŸš€ ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹..."; \
	echo ""; \
	SUCCESS_COUNT=0; \
	FAIL_COUNT=0; \
	SKIP_COUNT=0; \
	FAILED_FILES=""; \
	for sql_file in .db/web/*.sql; do \
		if [ -f "$$sql_file" ]; then \
		FILE_NAME=$$(basename "$$sql_file"); \
		if echo "$$FILE_NAME" | grep -q "^counter_"; then \
			echo "â­ï¸  [$$((SUCCESS_COUNT + FAIL_COUNT + SKIP_COUNT + 1))/$$FILE_COUNT] $$FILE_NAME - ã‚¹ã‚­ãƒƒãƒ— (äº’æ›æ€§ãªã—)"; \
			SKIP_COUNT=$$((SKIP_COUNT + 1)); \
			echo ""; \
			continue; \
		fi; \
		FILE_SIZE=$$(ls -lh "$$sql_file" | awk '{print $$5}'); \
		echo "ğŸ“„ [$$((SUCCESS_COUNT + FAIL_COUNT + SKIP_COUNT + 1))/$$FILE_COUNT] $$FILE_NAME ($$FILE_SIZE)..."; \
		ERROR_MSG=$$(PGPASSWORD="$$POSTGRES_PASSWORD" psql -h 127.0.0.1 -p 5433 -U "$$POSTGRES_USER" -d kishax_web -f "$$sql_file" 2>&1); \
			if [ $$? -eq 0 ]; then \
				echo "   âœ… æˆåŠŸ"; \
				SUCCESS_COUNT=$$((SUCCESS_COUNT + 1)); \
			else \
				echo "   âŒ å¤±æ•—"; \
				if [ -n "$$ERROR_MSG" ]; then \
					echo "   ğŸ“ ã‚¨ãƒ©ãƒ¼: $$(echo "$$ERROR_MSG" | head -n 1)"; \
				fi; \
				FAIL_COUNT=$$((FAIL_COUNT + 1)); \
				FAILED_FILES="$$FAILED_FILES  - $$FILE_NAME\n"; \
			fi; \
			echo ""; \
		fi; \
	done; \
	echo ""; \
	echo "========================================"; \
	echo "ğŸ“Š ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ"; \
	echo "========================================"; \
	echo "âœ… æˆåŠŸ: $$SUCCESS_COUNT / $$FILE_COUNT"; \
	echo "âŒ å¤±æ•—: $$FAIL_COUNT / $$FILE_COUNT"; \
	echo "â­ï¸  ã‚¹ã‚­ãƒƒãƒ—: $$SKIP_COUNT / $$FILE_COUNT"; \
	echo "========================================"; \
	if [ $$FAIL_COUNT -gt 0 ]; then \
		echo ""; \
		echo "âš ï¸  å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«:"; \
		echo -e "$$FAILED_FILES"; \
		echo "ğŸ’¡ å€‹åˆ¥ã«ç¢ºèªã™ã‚‹ã«ã¯:"; \
		echo "   make postgres-seed-import FILE=.db/web/[ãƒ•ã‚¡ã‚¤ãƒ«å]"; \
	fi; \
	if [ $$SKIP_COUNT -gt 0 ]; then \
		echo ""; \
		echo "ğŸ’¡ ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯äº’æ›æ€§ãŒãªã„ãŸã‚é™¤å¤–ã•ã‚Œã¾ã—ãŸ"; \
	fi

## =============================================================================
## RDSç®¡ç†
## =============================================================================

.PHONY: rds-status
rds-status: ## RDSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
	@echo "ğŸ“Š RDSã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
	aws rds describe-db-instances \
		--profile $(AWS_PROFILE) \
		--query 'DBInstances[*].[DBInstanceIdentifier,DBInstanceStatus,Engine,DBInstanceClass,Endpoint.Address]' \
		--output table

.PHONY: rds-connect-postgres
rds-connect-postgres: ## RDS PostgreSQLã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æ¥ç¶š
	@echo "ğŸ”— RDS PostgreSQLã«æ¥ç¶šä¸­ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒˆ5433ï¼‰..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw jump_server_id 2>/dev/null); \
	RDS_ENDPOINT=$$(cd terraform && terraform output -raw rds_postgres_endpoint 2>/dev/null); \
	aws ssm start-session \
		--target $$INSTANCE_ID \
		--document-name AWS-StartPortForwardingSessionToRemoteHost \
		--parameters "{\"portNumber\":[\"5432\"],\"localPortNumber\":[\"5433\"],\"host\":[\"$$RDS_ENDPOINT\"]}" \
		--profile $(AWS_PROFILE)

.PHONY: rds-connect-mysql
rds-connect-mysql: ## RDS MySQLã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æ¥ç¶š
	@echo "ğŸ”— RDS MySQLã«æ¥ç¶šä¸­ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒˆ3307ï¼‰..."
	@INSTANCE_ID=$$(cd terraform && terraform output -raw jump_server_id 2>/dev/null); \
	RDS_ENDPOINT=$$(cd terraform && terraform output -raw rds_mysql_endpoint 2>/dev/null); \
	aws ssm start-session \
		--target $$INSTANCE_ID \
		--document-name AWS-StartPortForwardingSessionToRemoteHost \
		--parameters "{\"portNumber\":[\"3306\"],\"localPortNumber\":[\"3307\"],\"host\":[\"$$RDS_ENDPOINT\"]}" \
		--profile $(AWS_PROFILE)

## =============================================================================
## SQSç®¡ç†
## =============================================================================

.PHONY: sqs-list
sqs-list: ## SQSã‚­ãƒ¥ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ SQSã‚­ãƒ¥ãƒ¼ä¸€è¦§:"
	aws sqs list-queues --profile $(AWS_PROFILE)

.PHONY: sqs-status
sqs-status: ## SQSã‚­ãƒ¥ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’ç¢ºèª
	@echo "ğŸ“Š SQSã‚­ãƒ¥ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
	@TO_WEB_QUEUE=$$(cd terraform && terraform output -raw to_web_queue_url 2>/dev/null); \
	TO_MC_QUEUE=$$(cd terraform && terraform output -raw to_mc_queue_url 2>/dev/null); \
	TO_DISCORD_QUEUE=$$(cd terraform && terraform output -raw to_discord_queue_url 2>/dev/null); \
	echo "To Web Queue:"; \
	aws sqs get-queue-attributes --queue-url $$TO_WEB_QUEUE --attribute-names ApproximateNumberOfMessages --profile $(AWS_PROFILE); \
	echo "To MC Queue:"; \
	aws sqs get-queue-attributes --queue-url $$TO_MC_QUEUE --attribute-names ApproximateNumberOfMessages --profile $(AWS_PROFILE); \
	echo "To Discord Queue:"; \
	aws sqs get-queue-attributes --queue-url $$TO_DISCORD_QUEUE --attribute-names ApproximateNumberOfMessages --profile $(AWS_PROFILE)

## =============================================================================
## CloudFrontç®¡ç†
## =============================================================================

.PHONY: cf-status
cf-status: ## CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
	@echo "ğŸ“Š CloudFrontã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
	aws cloudfront list-distributions \
		--profile $(AWS_PROFILE) \
		--query 'DistributionList.Items[*].[Id,Status,DomainName,Comment]' \
		--output table

.PHONY: cf-invalidate
cf-invalidate: ## CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
	@echo "ğŸ”„ CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ä¸­..."
	@DIST_ID=$$(cd terraform && terraform output -raw cloudfront_distribution_id 2>/dev/null); \
	aws cloudfront create-invalidation \
		--distribution-id $$DIST_ID \
		--paths "/*" \
		--profile $(AWS_PROFILE)

## =============================================================================
## Route53ç®¡ç†
## =============================================================================

.PHONY: route53-list
route53-list: ## Route53ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ Route53ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§:"
	@ZONE_ID=$$(cd terraform && terraform output -raw route53_zone_id 2>/dev/null); \
	aws route53 list-resource-record-sets \
		--hosted-zone-id $$ZONE_ID \
		--profile $(AWS_PROFILE) \
		--output table

## =============================================================================
## ç›£è¦–ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
## =============================================================================

.PHONY: billing-current
billing-current: ## ç¾åœ¨ã®èª²é‡‘é‡ã‚’ç¢ºèªï¼ˆä»Šæœˆï¼‰
	@echo "ğŸ’° AWSèª²é‡‘æƒ…å ±ã‚’å–å¾—ä¸­..."
	@START_DATE=$$(date +"%Y-%m-01"); \
	END_DATE=$$(date -v+1d +"%Y-%m-%d" 2>/dev/null || date -d "tomorrow" +"%Y-%m-%d"); \
	echo "ğŸ“Š èª²é‡‘æƒ…å ± ($$START_DATE ã‹ã‚‰ $$END_DATE ã¾ã§):"; \
	aws ce get-cost-and-usage \
		--time-period Start=$$START_DATE,End=$$END_DATE \
		--granularity DAILY \
		--metrics UnblendedCost \
		--profile $(AWS_PROFILE) \
		--output table

.PHONY: status-all
status-all: ## å…¨ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
	@echo "ğŸ” å…¨ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­..."
	@echo ""
	@$(MAKE) ec2-list
	@echo ""
	@$(MAKE) rds-status
	@echo ""
	@$(MAKE) cf-status

## =============================================================================
## SSM Parameter Store
## =============================================================================

.PHONY: ssm-list
ssm-list: ## SSM Parameter Storeä¸€è¦§ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ SSM Parameter Storeä¸€è¦§:"
	aws ssm describe-parameters \
		--profile $(AWS_PROFILE) \
		--query 'Parameters[*].[Name,Type,LastModifiedDate]' \
		--output table

.PHONY: ssm-get
ssm-get: ## SSM Parameterã®å€¤ã‚’å–å¾— (usage: make ssm-get PARAM=/path/to/param)
	@if [ -z "$(PARAM)" ]; then \
		echo "âŒ PARAMå¤‰æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„: make ssm-get PARAM=/path/to/param"; \
		exit 1; \
	fi
	@echo "ğŸ” SSM Parameterå–å¾—ä¸­: $(PARAM)"
	aws ssm get-parameter \
		--name "$(PARAM)" \
		--with-decryption \
		--profile $(AWS_PROFILE) \
		--query 'Parameter.Value' \
		--output text

## =============================================================================
## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
## =============================================================================

.PHONY: clean
clean: ## ãƒ­ãƒ¼ã‚«ãƒ«ã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
	@echo "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ä¸­..."
	rm -rf terraform/.terraform
	rm -f terraform/tfplan
	rm -f terraform/.terraform.lock.hcl
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
