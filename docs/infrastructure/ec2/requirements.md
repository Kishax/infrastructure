# AWSインフラを大きく変える。

まずは既存リソースを全て削除。

旧環境は、インフラ図：infrastructure.png に書いてあるとおり。企業レベルのインフラ構成。

新環境では、旧環境EC2の4台インスタンスによるものにし、コスト最適化を狙い、保守・運用を楽にする。

# EC2の要件
インスタンスは4つに分かれる。
それぞれ、i-a, i-b, i-c, i-d とする。
全てのインスタンスに共通すること
各EC2内ではVM（仮想環境）を提案する。
※マイクラサーバに至っても仮想環境内で動かそうと考えている。
各EC2同士のインスタンスはHTTP通信とする？（ここ相談事項）
## （i-a）
22:00-27:00をオンタイム時間とする。
t3.large(メモリ8GB以上)
マイクラサーバ本体。
大まかにインフラ図に書いてある、上部（Other Network）を担当。
apps/mc/compose.yml をそのまま動かすイメージ。
compose.yml について現在はMySQLがあるが、これ、どうしよう。統一してもよいかもしれない。i-bのpostgresに。
（別ユーザーでデータベースを分けるなどの対応が予想され、Javaプラグインのソースコードの改修が必要。工数多いが行う価値あり）
i-bには静的IPからアクセスする。
## （i-b）
24時間体制で動かす。
サイズは最小より多め？（相談したい）
マイクラサーバ本体のバックエンド。
大まかにインフラ図に書いてある、下部（AWS Network）を担当。
基本的には公開しないので、外部通信は遮断の上、閉域。
i-a, i-cからの内部ネットワーク通信は許可されている。
api(apps/api)を含む。
ここに、Redisを入れようか悩む。相談事項とする。
外部において、別々のユーザーでアクセスさせたら済むっちゃ済む。ただ、ElastiCacheはコスト高いので、私は推奨しない。EC2に設置するとしたら、だいぶ楽。
## (i-c)
24時間体制で動かす。
t2.microなど最小でよい。
cloudfrontで:80, :443で公開する。
web(apps/web)
i-aが22:00-27:00がオンタイムのため、それに合わせて、フロント部分を登録できないようにする。
「現在の時刻はMC認証できません。...」
discord-bot(apps/discord)
## (i-d)
データベースをホストマシンから操作するときにのみオンタイムになる。
RDSの踏み台サーバ。
基本的には停止しておく。

# 逆にEC2(i-a, i-b, i-c, i-d)以外のリソース
データベースはEC2環境外のRDS-PostgresSQLを採用する。

# セキュリティ要件
EC2のi-cで稼働するwebはWAFである、Cloudfrontを経由させる。webのパッケージアップデートを怠らないように。

# 技術スタック
旧環境では、Cloudformationだったが、新環境では、Terraformとする。
TerraformにはEC2などが含まれる
ここに含めるリソースは相談したい
基本的には旧環境のCloudformationみたいに企業レベルのインフラではなく、EC2でできるだけ簡潔するように組むようにする。
IAMに関して、追加するの忘れないようにするロール
docs/infrastructure/ec2/material-iam.md を要参照。
SQSは本当は依存したくはないが、ソースコードをあまり変えたくないので、そのまま使うものとする。

コスト最適化の面で、旧環境で、月1.7万円ぐらいだったのが、5-6千円ぐらいになる計算。
注意
旧環境は、企業レベル。
これ以上のインフラ環境はないと思って流。
だいぶ考えたので。
しかし高い。

新環境は、ミドルレベル。
機能的には一緒だが、ダウングレード。安価。