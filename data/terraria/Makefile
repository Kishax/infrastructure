# Terraria Server Makefile

.PHONY: download
download: ## S3ã‹ã‚‰æœ€æ–°ã®Terrariaã‚µãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
	@echo "ğŸ” S3ã‹ã‚‰æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œç´¢ä¸­..."
	@LATEST_YEARMONTH=$$(aws s3 ls s3://kishax-production-terraria-backups/deployment/ | grep PRE | awk '{print $$2}' | sed 's/\///' | sort -r | head -n 1); \
	LATEST_VERSION=$$(aws s3 ls s3://kishax-production-terraria-backups/deployment/$$LATEST_YEARMONTH/ | grep PRE | awk '{print $$2}' | sed 's/\///' | sort -rn | head -n 1); \
	echo "ğŸ“¦ æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $$LATEST_YEARMONTH/$$LATEST_VERSION"; \
	echo "ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."; \
	aws s3 sync s3://kishax-production-terraria-backups/deployment/$$LATEST_YEARMONTH/$$LATEST_VERSION/terraria/ /opt/terraria/ --delete; \
	echo "âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†"

.PHONY: upload
upload: ## S3ã¸Terrariaã‚µãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (--newã§æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆ)
	@if echo "$(filter-out upload,$(MAKECMDGOALS))" | grep -q "new"; then \
		echo "ğŸ†• æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™"; \
		YEARMONTH=$$(date +%Y%m); \
		LATEST_VERSION=$$(aws s3 ls s3://kishax-production-terraria-backups/deployment/$$YEARMONTH/ 2>/dev/null | grep PRE | awk '{print $$2}' | sed 's/\///' | sort -rn | head -n 1); \
		if [ -z "$$LATEST_VERSION" ]; then NEW_VERSION=1; else NEW_VERSION=$$(($$LATEST_VERSION + 1)); fi; \
		echo "ğŸ“¦ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $$YEARMONTH/$$NEW_VERSION"; \
		echo "ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."; \
		aws s3 sync /opt/terraria/ s3://kishax-production-terraria-backups/deployment/$$YEARMONTH/$$NEW_VERSION/terraria/ --delete; \
	else \
		echo "ğŸ” S3ã‹ã‚‰æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œç´¢ä¸­..."; \
		LATEST_YEARMONTH=$$(aws s3 ls s3://kishax-production-terraria-backups/deployment/ | grep PRE | awk '{print $$2}' | sed 's/\///' | sort -r | head -n 1); \
		LATEST_VERSION=$$(aws s3 ls s3://kishax-production-terraria-backups/deployment/$$LATEST_YEARMONTH/ | grep PRE | awk '{print $$2}' | sed 's/\///' | sort -rn | head -n 1); \
		echo "ğŸ“¦ æ—¢å­˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¸Šæ›¸ã: $$LATEST_YEARMONTH/$$LATEST_VERSION"; \
		echo "ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."; \
		aws s3 sync /opt/terraria/ s3://kishax-production-terraria-backups/deployment/$$LATEST_YEARMONTH/$$LATEST_VERSION/terraria/ --delete; \
	fi; \
	echo "âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"

# --new ãƒ•ãƒ©ã‚°ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦èªè­˜ã•ã›ãªã„ãŸã‚ã®ãƒ€ãƒŸãƒ¼
new:
	@:
