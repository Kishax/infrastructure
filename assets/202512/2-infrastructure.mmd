graph TB
    subgraph Internet["üåê Internet"]
        Users[Users/Players]
        MCPlayers[Minecraft Players]
    end

    subgraph AWS["‚òÅÔ∏è AWS Cloud - ap-northeast-1"]
        subgraph Route53["Route53"]
            R53MC[mc.kishax.net<br/>A Record]
            R53Web[kishax.net<br/>Alias Record]
        end

        subgraph CloudFront["CloudFront"]
            CF[Distribution<br/>kishax.net<br/>Port 443‚Üí80]
        end

        subgraph VPC["VPC - 10.0.0.0/16"]
            subgraph PublicSubnets["Public Subnets (2 AZs)"]
                subgraph AZ1Public["AZ-1a Public<br/>subnet-066*****"]
                    EIP[Elastic IP<br/>57.180.***.***]
                    EC2A[i-a: MC Server<br/>t3.large On-Demand<br/>Docker + Velocity + Spigot<br/>servers.jsonÁÆ°ÁêÜ]
                    EC2B[i-b: API + Redis<br/>t3.small Spot<br/>Private: 10.0.14.170<br/>Redis#1:6379 MCÁî®<br/>Redis#2:6380 WebÁî®]
                    EC2C[i-c: Web Server<br/>t2.micro Spot<br/>Next.js 16<br/>‚úÖ DEPLOYED]
                    EC2D[i-d: Jump Server<br/>t2.micro On-Demand<br/>DB Admin + SSH Tunnel]
                end
            end

            subgraph PrivateSubnets["Private Subnets (2 AZs)"]
                subgraph AZ1cPrivate["AZ-1c Private<br/>subnet-0a4*****"]
                    RDSPostgres[(RDS PostgreSQL v16.6<br/>db.t4g.micro<br/>Web + API + BotÁî®)]
                    RDSMySQL[(RDS MySQL v8.0.40<br/>db.t4g.micro<br/>MC ServerÁî®)]
                end
            end

            IGW[Internet Gateway]
            S3Endpoint[S3 VPC Gateway Endpoint<br/>FREE]
        end

        subgraph S3["Amazon S3"]
            S3Docker[kishax-prod-docker-images<br/>Lifecycle: 30 days<br/>Versioning: Enabled]
            S3TFState[kishax-terraform-state<br/>State + Lock]
        end

        subgraph SQS["Amazon SQS"]
            SQSDiscord[Discord Queue<br/>kishax-production-discord-queue]
            SQSToMC[To MC Queue<br/>kishax-production-to-mc-queue]
            SQSToWeb[To Web Queue<br/>kishax-production-to-web-queue]
        end

        subgraph IAM["IAM"]
            IAMRoles[EC2 Instance Roles<br/>mc_server_role<br/>api_server_role<br/>web_server_role<br/>jump_server_role]
            IAMUser[SQS IAM User<br/>Access Keys in SSM]
        end

        subgraph SSM["Systems Manager"]
            SSMParams[Parameter Store<br/>/kishax/production/sqs/*<br/>Access Key + Secret]
        end
    end

    %% External connections
    MCPlayers -->|TCP 25565<br/>25577| R53MC
    Users -->|HTTPS 443| R53Web
    
    %% Route53 connections
    R53MC -->|Dynamic IP Update<br/>Lambda or User Data| EIP
    R53Web -->|Alias| CF
    
    %% CloudFront connection
    CF -->|HTTP 80<br/>Origin| EC2C
    
    %% EIP connection
    EIP -.->|Associated| EC2A
    
    %% Internet Gateway connections
    IGW -->|Public Access| EC2A
    IGW -->|Public Access| EC2B
    IGW -->|Public Access| EC2C
    IGW -->|Public Access| EC2D
    
    %% EC2 internal communications (HTTP)
    EC2A <-->|HTTP API<br/>Auth + Messages| EC2B
    EC2C <-->|HTTP API<br/>Internal API Key| EC2B
    EC2A -->|Redis #1<br/>6379| EC2B
    EC2C -->|Redis #2<br/>6380| EC2B
    
    %% Database connections
    EC2A -->|MySQL 3306<br/>Spigot + Velocity| RDSMySQL
    EC2B -->|PostgreSQL 5432<br/>API Server| RDSPostgres
    EC2C -->|PostgreSQL 5432<br/>Next.js App| RDSPostgres
    
    %% SQS connections
    EC2A <-->|SQS Messages<br/>IAM User Keys| SQSToMC
    EC2B <-->|Bridge Pattern| SQSDiscord
    EC2B <-->|Bridge Pattern| SQSToWeb
    EC2C <-->|SQS Messages| SQSDiscord
    
    %% S3 Connections
    EC2A -.->|Docker Image<br/>Upload/Download| S3Docker
    EC2B -.->|Docker Image<br/>Upload/Download| S3Docker
    EC2C -.->|Docker Image<br/>Upload/Download| S3Docker
    S3Endpoint -.->|Gateway| S3Docker
    
    %% Jump Server access
    EC2D -.->|Port Forward<br/>PostgreSQL Admin| RDSPostgres
    EC2D -.->|Port Forward<br/>MySQL Admin| RDSMySQL
    EC2D -.->|SSH Tunnel<br/>to i-a/i-b/i-c| EC2A
    
    %% IAM associations
    IAMRoles -.->|Instance Profile| EC2A
    IAMRoles -.->|Instance Profile| EC2B
    IAMRoles -.->|Instance Profile| EC2C
    IAMRoles -.->|Instance Profile| EC2D
    IAMUser -.->|Access Keys| SQS
    
    %% SSM Parameter access
    EC2A -.->|Read SQS Keys| SSMParams
    EC2B -.->|Read SQS Keys| SSMParams
    EC2C -.->|Read SQS Keys| SSMParams

    %% Annotations
    note1[üí° i-b moved to Public Subnet<br/>for cost optimization<br/>No NAT Gateway needed]
    note2[üí° CloudFront: Port 80 origin<br/>No default_root_object<br/>Next.js routing]
    note3[üí° S3 Docker Images<br/>Cross-architecture build<br/>ARM64 Mac ‚Üí x86_64 EC2]
    note4[üí° MC Server: servers.json<br/>Dynamic memory allocation<br/>Template-based directories<br/>Auto plugin deployment]

    classDef internet fill:#e1f5ff,stroke:#0078d4,stroke-width:3px
    classDef cloudfront fill:#ffeaa7,stroke:#fdcb6e,stroke-width:3px
    classDef ec2 fill:#a8e6cf,stroke:#56ab2f,stroke-width:3px
    classDef ec2deployed fill:#81c784,stroke:#2e7d32,stroke-width:4px
    classDef rds fill:#ffcccc,stroke:#ff6b6b,stroke-width:3px
    classDef sqs fill:#dfe6e9,stroke:#636e72,stroke-width:3px
    classDef s3 fill:#ffd32a,stroke:#ff9f1a,stroke-width:3px
    classDef route53 fill:#ffeaa7,stroke:#fdcb6e,stroke-width:3px
    classDef iam fill:#c7ecee,stroke:#079992,stroke-width:3px
    classDef note fill:#fff3cd,stroke:#856404,stroke-width:2px,stroke-dasharray: 5 5
    
    class Users,MCPlayers internet
    class CF cloudfront
    class EC2A,EC2B,EC2D ec2
    class EC2C ec2deployed
    class RDSPostgres,RDSMySQL rds
    class SQSDiscord,SQSToMC,SQSToWeb sqs
    class S3Docker,S3TFState s3
    class R53MC,R53Web route53
    class IAMRoles,IAMUser,SSMParams iam
    class note1,note2,note3,note4 note
