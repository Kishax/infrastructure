# Kishax Infrastructure - ä»Šå¾Œã®æ”¹å–„èª²é¡Œ

**ä½œæˆæ—¥**: 2025-12-14  
**å¯¾è±¡**: Productionç’°å¢ƒã®å°†æ¥çš„ãªæ”¹å–„

---

## ğŸ“‹ æ¦‚è¦

ç¾åœ¨ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã¯**ã‚³ã‚¹ãƒˆæœ€é©åŒ–**ã‚’æœ€å„ªå…ˆã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®è³‡æ–™ã§ã¯ã€å°†æ¥çš„ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚„ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®æ”¹å–„æ¡ˆã‚’ã¾ã¨ã‚ã¾ã™ã€‚

---

## ğŸ¯ ç¾åœ¨ã®æ§‹æˆã¨é¸æŠç†ç”±

### EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é…ç½®

| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ | Subnet | ç†ç”± |
|------------|--------|------|
| **i-a** (MC Server) | Public | Elastic IPå¿…é ˆã€Minecraftæ¥ç¶š |
| **i-b** (API Server) | **Public** | **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹å¿…é ˆï¼ˆDocker Hub, Discord APIï¼‰ã€NAT Gatewayå›é¿** |
| **i-c** (Web Server) | Public | CloudFront Origin |
| **i-d** (Jump Server) | Public | SSM Agentæ¥ç¶šã®ãŸã‚ |

### ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®é¸æŠ

i-b (API Server)ã¯æœ¬æ¥Private Subnetã«é…ç½®ã™ã¹ãã§ã™ãŒã€ä»¥ä¸‹ã®ç†ç”±ã§Public Subnetã‚’é¸æŠï¼š

**Private Subneté…ç½®æ™‚ã®è¿½åŠ ã‚³ã‚¹ãƒˆ**:
- NAT Gateway: **$32/æœˆ** (~Â¥4,800)
- ã¾ãŸã¯ VPC Endpoints (S3 + SQS + SSM): **$22/æœˆ** (~Â¥3,300)
  - âš ï¸ ãŸã ã—ã€Discord APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯ä¸ååˆ†ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå¿…é ˆï¼‰

**Public Subneté…ç½®ã®ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… è¿½åŠ ã‚³ã‚¹ãƒˆ **$0**
- âœ… ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆDocker Hub, Discord APIç­‰ï¼‰
- âœ… ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**:
- Security Groupã§é©åˆ‡ã«ä¿è­·
  - Port 8080: MC/Webã‹ã‚‰ã®ã¿
  - Port 6379/6380: MC/Webã‹ã‚‰ã®ã¿ï¼ˆRedisï¼‰
  - Port 22: Jump Serverã‹ã‚‰ã®ã¿
- å¤–éƒ¨ã‹ã‚‰ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã¯ä¸å¯

---

## ğŸš€ å°†æ¥ã®æ”¹å–„æ¡ˆ

### æ¡ˆ1: Discord Botã‚’ç‹¬ç«‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆi-eï¼‰ã«åˆ†é›¢

#### æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Public Subnet 1                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  i-a (MC)   â”‚  â”‚  i-c (Web)  â”‚  â”‚  i-d (Jump) â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Public Subnet 2                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚  i-e (Discord)   â”‚  â† æ–°è¦è¿½åŠ                         â”‚
â”‚  â”‚  - Discord Bot   â”‚                                   â”‚
â”‚  â”‚  - Redis (Web)   â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Private Subnet                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  i-b (API)        â”‚  â† Private Subnetã«æˆ»ã™            â”‚
â”‚  â”‚  - MC Auth API    â”‚                                  â”‚
â”‚  â”‚  - SQS Bridge     â”‚                                  â”‚
â”‚  â”‚  - Redis (MC)     â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ãƒ¡ãƒªãƒƒãƒˆ

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š**
   - i-b (API Server)ã‚’Private Subnetã«æˆ»ã›ã‚‹
   - MCèªè¨¼APIã¨Redisã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰å®Œå…¨ã«éš”é›¢
   - Discord Botã®ã¿ãŒPublicã«å…¬é–‹

2. **éšœå®³ã®åˆ†é›¢**
   - Discord Botã®éšœå®³ãŒAPI Serverã«å½±éŸ¿ã—ãªã„
   - ç‹¬ç«‹ã—ãŸã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒå¯èƒ½

3. **NAT Gatewayä¸è¦**
   - i-eã¯Public Subnetãªã®ã§NAT Gatewayä¸è¦
   - i-bã¯Discord APIã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ãŸã‚ã€VPC Endpointsï¼ˆS3, SQSï¼‰ã®ã¿ã§å‹•ä½œå¯èƒ½

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **è¿½åŠ ã‚³ã‚¹ãƒˆ**
   - i-e (t2.micro Spot): **ç´„$3.5/æœˆ**
   - VPC Endpoints (S3ç„¡æ–™ + SQS): **ç´„$7.2/æœˆ**
   - **åˆè¨ˆ: ç´„$10.7/æœˆ (~Â¥1,600)**

2. **é‹ç”¨è¤‡é›‘åŒ–**
   - ç®¡ç†ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ1ã¤å¢—åŠ 
   - Redisæ¥ç¶šå…ˆã®å¤‰æ›´ãŒå¿…è¦

#### å®Ÿè£…æ‰‹é †

1. **Terraformã§i-eã‚’è¿½åŠ **
   ```hcl
   resource "aws_spot_instance_request" "discord_server" {
     ami           = data.aws_ami.amazon_linux_2.id
     instance_type = "t2.micro"
     subnet_id     = var.public_subnet_ids[1]
     # ...
   }
   ```

2. **VPC Endpointsã‚’è¿½åŠ **ï¼ˆi-bç”¨ï¼‰
   - S3 Gateway Endpointï¼ˆç„¡æ–™ï¼‰
   - SQS Interface Endpointï¼ˆ$7.2/æœˆï¼‰

3. **Discord Botã‚’i-eã«ç§»è¡Œ**
   - `apps/api/discord-bot` â†’ ç‹¬ç«‹ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤
   - Redis (Web)ã‚‚i-eã«ç§»å‹•

4. **i-bã‚’Private Subnetã«æˆ»ã™**
   ```hcl
   subnet_id = var.private_subnet_ids[0]
   associate_public_ip_address = false
   ```

5. **Security Groupæ›´æ–°**
   - i-eç”¨ã®æ–°ã—ã„SGã‚’ä½œæˆ
   - i-b â†’ i-eé–“ã®é€šä¿¡ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 

---

### æ¡ˆ2: NAT Gatewayã‚’è¿½åŠ ã—ã¦Private Subneté‹ç”¨

#### æ§‹æˆ

ç¾åœ¨ã®ã¾ã¾ã€NAT Gatewayã‚’è¿½åŠ ã—ã¦i-bã‚’Private Subnetã«æˆ»ã™ã€‚

#### ãƒ¡ãƒªãƒƒãƒˆ

1. **å®Œå…¨ãªPrivate Subneté‹ç”¨**
   - i-bãŒå®Œå…¨ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰éš”é›¢
   - æœ€ã‚‚ã‚»ã‚­ãƒ¥ã‚¢ãªæ§‹æˆ

2. **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ**
   - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã¯å¤‰ã‚ã‚‰ãš
   - VPC Endpointsã‚‚ä¸è¦

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **é«˜é¡ãªè¿½åŠ ã‚³ã‚¹ãƒˆ**
   - NAT Gateway: **$32/æœˆ (~Â¥4,800)**
   - ãƒ‡ãƒ¼ã‚¿è»¢é€æ–™: $0.045/GB

2. **ç¾åœ¨ã®äºˆç®—ç›®æ¨™ï¼ˆÂ¥5,000-6,000ï¼‰ã‚’å¤§å¹…è¶…é**

#### å®Ÿè£…æ‰‹é †

1. **NAT Gatewayã‚’è¿½åŠ **
   ```hcl
   resource "aws_eip" "nat" {
     domain = "vpc"
   }
   
   resource "aws_nat_gateway" "main" {
     allocation_id = aws_eip.nat.id
     subnet_id     = var.public_subnet_ids[0]
   }
   ```

2. **Private Route Tableã‚’æ›´æ–°**
   ```hcl
   resource "aws_route" "private_nat" {
     route_table_id         = aws_route_table.private.id
     destination_cidr_block = "0.0.0.0/0"
     nat_gateway_id         = aws_nat_gateway.main.id
   }
   ```

3. **i-bã‚’Private Subnetã«æˆ»ã™**

---

## ğŸ“Š æ¯”è¼ƒè¡¨

| é …ç›® | ç¾åœ¨ã®æ§‹æˆ | æ¡ˆ1: i-eåˆ†é›¢ | æ¡ˆ2: NAT Gateway |
|-----|----------|-------------|-----------------|
| **æœˆé¡è¿½åŠ ã‚³ã‚¹ãƒˆ** | **$0** | **$10.7** (~Â¥1,600) | **$32+** (~Â¥4,800+) |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | ä¸­ | **é«˜** | **æœ€é«˜** |
| **é‹ç”¨è¤‡é›‘åº¦** | ä½ | ä¸­ | ä½ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | ä¸­ | **é«˜** | ä¸­ |
| **å®Ÿè£…å·¥æ•°** | - | ä¸­ | å° |

---

## ğŸ¯ æ¨å¥¨å®Ÿè£…ã‚¿ã‚¤ãƒŸãƒ³ã‚°

### ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆç¾åœ¨ï¼‰: ã‚³ã‚¹ãƒˆæœ€é©åŒ–å„ªå…ˆ
- âœ… å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹Public Subneté…ç½®
- âœ… æœˆé¡äºˆç®—: Â¥5,000-6,000é”æˆ

### ãƒ•ã‚§ãƒ¼ã‚º2ï¼ˆåç›Šå®‰å®šå¾Œï¼‰: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š
- ğŸ“… **æ¡ˆ1ã‚’å®Ÿè£…**: Discord Botåˆ†é›¢ï¼ˆi-eè¿½åŠ ï¼‰
- ğŸ’° è¿½åŠ æŠ•è³‡: ç´„Â¥1,600/æœˆ
- ğŸ”’ i-bã‚’Private Subnetã«æˆ»ã™

### ãƒ•ã‚§ãƒ¼ã‚º3ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«æ™‚ï¼‰: ã•ã‚‰ãªã‚‹æ”¹å–„
- Multi-AZæ§‹æˆ
- RDS Multi-AZåŒ–
- Auto Scalingå°å…¥
- CloudWatch Logsé›†ç´„

---

## ğŸ“ ãƒ¡ãƒ¢

### ãªãœi-bã‚’Public Subnetã«ï¼Ÿ

ç¾åœ¨ã®æ§‹æˆã§ã¯ã€i-bã§ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå‹•ä½œï¼š
1. MCèªè¨¼API
2. SQS-Redis Bridge
3. **Discord Bot** â† ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆï¼ˆDiscord APIï¼‰å¿…é ˆ
4. Redis x2

Discord BotãŒDiscord APIã¨é€šä¿¡ã™ã‚‹ãŸã‚ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…é ˆã§ã™ã€‚Private Subnetã«é…ç½®ã™ã‚‹ã¨NAT Gatewayï¼ˆ$32/æœˆï¼‰ãŒå¿…è¦ã«ãªã‚Šã€ã‚³ã‚¹ãƒˆç›®æ¨™ã‚’è¶…éã—ã¾ã™ã€‚

å°†æ¥çš„ã«**æ¡ˆ1**ã‚’å®Ÿè£…ã™ã‚Œã°ã€Discord Botã‚’i-eã«åˆ†é›¢ã—ã€i-bã‚’Private Subnetã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [requirements.md](./requirements.md) - ç¾åœ¨ã®è¦ä»¶å®šç¾©
- [deployment.md](./deployment.md) - ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
- [application-in-ec2.md](./application-in-ec2.md) - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ
