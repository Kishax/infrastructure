# Integration Test Makefile

include .env

.PHONY: help test-integration test-mc-plugins test-api-gateway test-discord-bot test-web test-player-leave test-player-join clean-test setup-test

help: ## çµ±åˆãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo "Integration Test Commands"
	@echo ""
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

## =============================================================================
## çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
## =============================================================================

test-integration: ## å…¨çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ğŸš€ çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹..."
	@echo ""
	@echo "ãƒ†ã‚¹ãƒˆå¯¾è±¡:"
	@echo "  - mc-discord: MC â†’ Discordé€šä¿¡ï¼ˆAPI GatewayçµŒç”±ï¼‰"
	@echo "  - mc-web-bidirectional: MC â†” WebåŒæ–¹å‘é€šä¿¡ï¼ˆSQSç›´æ¥ï¼‰"
	@echo "  - web-mc-auth: Web â†’ MCèªè¨¼ï¼ˆAPI GatewayçµŒç”±ï¼‰"
	@echo "  - legacy: æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰"
	@echo ""
	./gradlew clean integrationTest --info
	@echo ""
	@echo "âœ… å…¨çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†"

test-mc-plugins: ## Minecraftãƒ—ãƒ©ã‚°ã‚¤ãƒ³çµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸ® Minecraft Plugin â†’ API Gateway çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*McPlugin*" --info

test-api-gateway: ## API Gatewayçµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸŒ API Gateway â†’ Lambda â†’ SQS çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*ApiGateway*" --info

test-mc-discord: ## MCâ†’Discordé€šä¿¡çµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸ¤– MCâ†’Discordé€šä¿¡çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*McDiscordCommunication*" --info

test-discord-bot: ## Discord Botçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
	@echo "ğŸ¤– Discord Bot SQSå‡¦ç†çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*DiscordBot*" --info

test-discord-events: ## å…¨Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆçµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸ® å…¨Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@echo "ãƒ†ã‚¹ãƒˆå¯¾è±¡: player_join, player_leave, server_status"
	./gradlew clean test --tests "*shouldHandleMultipleMessageTypesViaApiGateway*" --info

test-player-leave: ## Player Leave ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸšª Player Leave ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@echo "ãƒ†ã‚¹ãƒˆå¯¾è±¡: player_leave ã‚¤ãƒ™ãƒ³ãƒˆ"
	./gradlew clean test --tests "*shouldSendPlayerLeaveMessageViaApiGateway*" --info

test-player-join: ## Player Join ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸ® Player Join ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@echo "ãƒ†ã‚¹ãƒˆå¯¾è±¡: player_join ã‚¤ãƒ™ãƒ³ãƒˆ"
	./gradlew clean test --tests "*shouldSendPlayerJoinMessageViaApiGateway*" --info

test-mc-web-bidirectional: ## MCâ†”WebåŒæ–¹å‘é€šä¿¡çµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸ”„ MCâ†”WebåŒæ–¹å‘é€šä¿¡çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*McWebBidirectional*" --info

test-web-mc-auth: ## Webâ†’MCèªè¨¼çµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸ” Webâ†’MCèªè¨¼çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*WebMcAuth*" --info

test-web: ## Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
	@echo "ğŸŒ Web Application çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*Web*" --info

## =============================================================================
## é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ãƒ†ã‚¹ãƒˆ
## =============================================================================

test-all-communication-patterns: ## å…¨é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
	@echo "ğŸ”„ å…¨é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@echo "å®Ÿè¡Œé †åº: MCâ†’Discord, MCâ†”Web, Webâ†’MC"
	make test-mc-discord
	make test-mc-web-bidirectional  
	make test-web-mc-auth
	@echo "âœ… å…¨é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº†"

## =============================================================================
## å€‹åˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
## =============================================================================

test-full-flow: ## å®Œå…¨ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆMC â†’ Discordï¼‰
	@echo "ğŸ”„ å®Œå…¨çµ±åˆãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@echo "ãƒ•ãƒ­ãƒ¼: Minecraft Plugin â†’ API Gateway â†’ Lambda â†’ SQS â†’ Discord Bot"
	./gradlew clean test --tests "*FullFlow*" --info

test-auth-flow: ## èªè¨¼ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ
	@echo "ğŸ” èªè¨¼ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	./gradlew clean test --tests "*Auth*" --info

## =============================================================================
## ãƒ†ã‚¹ãƒˆçµæœã¨ãƒ¬ãƒãƒ¼ãƒˆ
## =============================================================================

test-report: ## ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
	@echo "ğŸ“Š çµ±åˆãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ:"
	@echo ""
	@if [ -f build/reports/tests/integrationTest/index.html ]; then \
		echo "ğŸ“„ HTML ãƒ¬ãƒãƒ¼ãƒˆ: build/reports/tests/integrationTest/index.html"; \
		echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸: build/reports/jacoco/test/html/index.html"; \
	else \
		echo "âŒ ãƒ†ã‚¹ãƒˆçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã« 'make test-integration' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"; \
	fi

test-logs: ## ãƒ†ã‚¹ãƒˆãƒ­ã‚°ç¢ºèª
	@echo "ğŸ“‹ çµ±åˆãƒ†ã‚¹ãƒˆãƒ­ã‚°:"
	@if [ -f build/reports/tests/integrationTest/index.html ]; then \
		find build/test-results -name "*.xml" -exec echo "ğŸ“„ {}" \; -exec cat {} \; | head -50; \
	else \
		echo "âŒ ãƒ†ã‚¹ãƒˆãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi

## =============================================================================
## ãƒ‡ãƒãƒƒã‚°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
## =============================================================================

debug-aws: ## AWSæ¥ç¶šç¢ºèª
	@echo "ğŸ” AWSæ¥ç¶šç¢ºèªä¸­..."
	@echo "Profile: $(AWS_PROFILE)"
	aws sts get-caller-identity --profile $(AWS_PROFILE) || echo "âŒ AWSèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
	aws apigateway get-rest-api --rest-api-id 043t0plyrl --profile $(AWS_PROFILE) --query '{id:id,name:name}' || echo "âŒ API Gatewayæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
	aws sqs get-queue-attributes --queue-url $(shell aws ssm get-parameter --name "/kishax/sqs/queue-url" --with-decryption --profile $(AWS_PROFILE) --query 'Parameter.Value' --output text) --attribute-names QueueArn --profile $(AWS_PROFILE) || echo "âŒ SQSæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
